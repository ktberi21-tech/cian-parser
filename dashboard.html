<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cian Parser - Dashboard</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; }
        .header h1 { margin: 0; font-size: 2.5em; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header p { margin: 10px 0 0 0; opacity: 0.95; }
        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin: 10px 0; background: #d4edda; color: #155724; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s, box-shadow 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .card h2 { margin: 0 0 15px 0; color: #667eea; font-size: 1.5em; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .metric { margin: 15px 0; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; color: #555; }
        .metric-value { font-size: 1.2em; color: #667eea; font-weight: bold; }
        .section { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section h2 { color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; margin-top: 0; }
        .btn { display: inline-block; background: #667eea; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-size: 1em; transition: background 0.3s; margin: 10px 10px 10px 0; font-weight: 600; }
        .btn:hover:not(:disabled) { background: #764ba2; }
        .btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
        .btn.secondary { background: #f0f0f0; color: #667eea; }
        .btn.secondary:hover:not(:disabled) { background: #e0e0e0; }
        .apartment { background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #667eea; }
        .apartment h3 { margin: 0 0 10px 0; color: #333; font-size: 1.1em; }
        .apartment-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; font-size: 0.85em; color: #666; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert { padding: 15px; border-radius: 4px; margin: 15px 0; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat-box .label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .stat-box .value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .apartments-list { max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Cian Parser Dashboard</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ —Å real-time API</p>
            <span class="status-badge" id="status-badge">‚úÖ –°–ò–°–¢–ï–ú–ê –ê–ö–¢–ò–í–ù–ê</span>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìä –°—Ç–∞—Ç—É—Å API</h2>
                <div class="metric">
                    <span class="metric-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="metric-value" id="api-status">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–ü–æ—Ä—Ç:</span>
                    <span class="metric-value">5004</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–í–µ—Ä—Å–∏—è:</span>
                    <span class="metric-value" id="api-version">--</span>
                </div>
            </div>

            <div class="card">
                <h2>üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
                <div class="metric">
                    <span class="metric-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="metric-value" id="db-status">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–û–±—ä—è–≤–ª–µ–Ω–∏–π:</span>
                    <span class="metric-value" id="apartment-count">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–¢–∏–ø:</span>
                    <span class="metric-value">MongoDB</span>
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è –ü–∞—Ä—Å–µ—Ä</h2>
                <div class="metric">
                    <span class="metric-label">–†–µ–∂–∏–º:</span>
                    <span class="metric-value" id="parser-mode">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="metric-value" id="parser-status">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:</span>
                    <span class="metric-value" id="parser-ready">--</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–º</h2>
            <div style="margin: 20px 0;">
                <button class="btn" id="parse-btn" onclick="runParser()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä (Real Mode)</button>
                <button class="btn secondary" onclick="refreshStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                <button class="btn secondary" onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON</button>
            </div>
            <div id="alerts"></div>
            <div class="stats-grid" id="stats-grid" style="display: none;">
                <div class="stat-box">
                    <div class="label">–°–ø–∞—Ä—Å–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
                    <div class="value" id="stat-count">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
                    <div class="value" id="stat-avg-price">--</div>
                </div>
                <div class="stat-box">
                    <div class="label">–°—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å</div>
                    <div class="value" id="stat-avg-area">--</div>
                </div>
                <div class="stat-box">
                    <div class="label">–í—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞</div>
                    <div class="value" id="stat-time">--</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üè† –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
            <div class="apartments-list" id="apartments-list">
                <p style="text-align: center; color: #999;">‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è...</p>
            </div>
        </div>

        <div class="section">
            <h2>üìã API Endpoints</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background: #667eea; color: white;">
                    <th style="padding: 12px; text-align: left;">–ú–µ—Ç–æ–¥</th>
                    <th style="padding: 12px; text-align: left;">Endpoint</th>
                    <th style="padding: 12px; text-align: left;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;">GET</td>
                    <td style="padding: 12px;"><code>/api/health</code></td>
                    <td style="padding: 12px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;">POST</td>
                    <td style="padding: 12px;"><code>/api/parse-html</code></td>
                    <td style="padding: 12px;">–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;">GET</td>
                    <td style="padding: 12px;"><code>/api/stats</code></td>
                    <td style="padding: 12px;">–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</td>
                </tr>
                <tr>
                    <td style="padding: 12px;">GET</td>
                    <td style="padding: 12px;"><code>/api/flats?limit=N</code></td>
                    <td style="padding: 12px;">–°–ø–∏—Å–æ–∫ –∫–≤–∞—Ä—Ç–∏—Ä</td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5004/api';

        window.addEventListener('load', () => {
            checkHealth();
            loadApartments();
        });

        async function checkHealth() {
            try {
                const response = await fetch(API_BASE + '/health');
                const data = await response.json();
                document.getElementById('api-status').textContent = '‚úÖ –†–ê–ë–û–¢–ê–ï–¢';
                document.getElementById('api-version').textContent = data.api_version || '2.1';
                document.getElementById('db-status').textContent = data.db_connected ? '‚úÖ –ü–û–î–ö–õ–Æ–ß–ï–ù–ê' : '‚ùå –û–®–ò–ë–ö–ê';
                document.getElementById('parser-mode').textContent = data.parser_type || 'CianRealParserV2';
                document.getElementById('parser-status').textContent = data.parser_ready ? '‚úÖ –ì–û–¢–û–í' : '‚ö†Ô∏è –ù–ï –ì–û–¢–û–í';
                document.getElementById('parser-ready').textContent = '‚úÖ 100%';
            } catch (error) {
                showAlert('‚ùå –ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API –Ω–∞ localhost:5004', 'error');
                document.getElementById('api-status').textContent = '‚ùå –û–®–ò–ë–ö–ê';
            }
        }

        async function runParser() {
            const btn = document.getElementById('parse-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> –ü–∞—Ä—Å–∏–Ω–≥...';
            try {
                showAlert('‚è≥ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º HTML...', 'info');
                const response = await fetch(API_BASE + '/parse-html', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showAlert('‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–ø–∞—Ä—Å–µ–Ω–æ ' + data.apartments + ' –æ–±—ä—è–≤–ª–µ–Ω–∏–π!', 'success');
                    await loadApartments();
                    await refreshStats();
                } else {
                    showAlert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä (Real Mode)';
            }
        }

        async function loadApartments() {
            try {
                const response = await fetch(API_BASE + '/flats?limit=100');
                const data = await response.json();
                const apartments = data.flats || [];
                const container = document.getElementById('apartments-list');

                if (!apartments || apartments.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">üì≠ –û–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–∞—Ä—Å–µ—Ä.</p>';
                    return;
                }

                let html = '';
                for (const apt of apartments.slice(0, 20)) {
                    const color = ['üî¥', 'üîµ', 'üü¢', 'üü°', 'üü£', 'üü†'][Math.floor(Math.random() * 6)];
                    html += '<div class="apartment"><h3>' + color + ' ' + (apt.title || apt.address || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + '</h3><div class="apartment-info">';
                    if (apt.rooms) html += '<div>üè† ' + apt.rooms + ' –∫–æ–º–Ω.</div>';
                    if (apt.area) html += '<div>üìê ' + apt.area + ' –º¬≤</div>';
                    if (apt.price) html += '<div>üí∞ ‚ÇΩ' + Math.round(apt.price).toLocaleString('ru-RU') + '</div>';
                    if (apt.floor) html += '<div>üè¢ ' + apt.floor + '/' + (apt.total_floors || '?') + ' —ç—Ç–∞–∂</div>';
                    if (apt.year) html += '<div>üìÖ ' + apt.year + ' –≥.</div>';
                    html += '</div></div>';
                }
                
                container.innerHTML = html;
                if (apartments.length > 20) {
                    container.innerHTML += '<p style="text-align: center; color: #999; font-size: 0.9em;">... –∏ –µ—â—ë ' + (apartments.length - 20) + ' –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
                }
                document.getElementById('apartment-count').textContent = apartments.length;
            } catch (error) {
                document.getElementById('apartments-list').innerHTML = '<p style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</p>';
            }
        }

        async function refreshStats() {
            try {
                const response = await fetch(API_BASE + '/stats');
                const stats = await response.json();
                document.getElementById('stats-grid').style.display = 'grid';
                document.getElementById('stat-count').textContent = stats.total_apartments || 0;
                document.getElementById('stat-avg-price').textContent = stats.avg_price ? '‚ÇΩ' + Math.round(stats.avg_price).toLocaleString('ru-RU') : '--';
                document.getElementById('stat-avg-area').textContent = stats.avg_area ? stats.avg_area.toFixed(1) + ' –º¬≤' : '--';
                document.getElementById('stat-time').textContent = (stats.parse_time_ms || '?') + ' ms';
                showAlert('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
            }
        }

        async function exportData() {
            try {
                const response = await fetch(API_BASE + '/flats?limit=1000');
                const data = await response.json();
                const json = JSON.stringify(data.flats, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'apartments-' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                showAlert('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ' + data.flats.length + ' –æ–±—ä—è–≤–ª–µ–Ω–∏–π', 'success');
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            alerts.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
    </script>
</body>
</html>
